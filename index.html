<script>
  const tables = {};
  const usedTableNumbers = new Set();

  setInterval(() => {
    document.getElementById("clock").textContent = `เวลา: ${new Date().toLocaleTimeString("th-TH", { hour12: false })}`;
  }, 1000);

  function showNotification(message) {
    const note = document.getElementById("notification");
    note.textContent = message;
    note.style.display = "block";
    setTimeout(() => (note.style.display = "none"), 4000);
  }

  function calculateMMS(lambda, mu, s) {
    const ρ = lambda / (s * mu);
    if (ρ >= 1) return null;

    let sum = 0;
    for (let k = 0; k < s; k++) {
      sum += Math.pow(lambda / mu, k) / factorial(k);
    }
    const lastTerm = Math.pow(lambda / mu, s) / (factorial(s) * (1 - ρ));
    const P0 = 1 / (sum + lastTerm);

    const Lq = (P0 * Math.pow(lambda / mu, s) * ρ) / (factorial(s) * Math.pow(1 - ρ, 2));
    const Wq = Lq / lambda; // หน่วยเป็น "นาที"
    return Wq;
  }

  function factorial(n) {
    return n <= 1 ? 1 : n * factorial(n - 1);
  }

  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins} นาที ${secs} วินาที`;
  }

  function addTable() {
    const tableNumber = parseInt(document.getElementById("tableNumber").value);
    const lambda = parseFloat(document.getElementById("lambda").value);
    const mu = parseFloat(document.getElementById("mu").value);
    const s = parseInt(document.getElementById("servers").value);

    if (isNaN(tableNumber) || tableNumber < 1) {
      showNotification("กรุณาใส่หมายเลขโต๊ะให้ถูกต้อง");
      return;
    }
    if (usedTableNumbers.has(tableNumber) || tables[tableNumber]) {
      showNotification(`โต๊ะ ${tableNumber} ถูกใช้งานหรือเคยใช้งานแล้ว`);
      return;
    }
    if (isNaN(lambda) || isNaN(mu) || isNaN(s) || lambda <= 0 || mu <= 0 || s < 1) {
      showNotification("กรุณาใส่ λ, μ และจำนวนพนักงานให้ถูกต้อง");
      return;
    }

    const waitTime = calculateMMS(lambda, mu, s);
    if (waitTime === null) {
      showNotification("ระบบเกินความสามารถในการบริการ (λ ≥ sμ)");
      return;
    }

    const durationInSeconds = Math.ceil(waitTime * 60);
    tables[tableNumber] = { remainingTime: durationInSeconds };
    usedTableNumbers.add(tableNumber);

    showNotification(`โต๊ะ ${tableNumber} เพิ่มแล้ว (${formatTime(durationInSeconds)})`);

    updateTables();

    const interval = setInterval(() => {
      if (tables[tableNumber]) {
        if (tables[tableNumber].remainingTime > 0) {
          tables[tableNumber].remainingTime--;
          updateTables();
        } else {
          clearInterval(interval);
          removeTable(tableNumber);
        }
      }
    }, 1000);
  }

  function removeTable(tableNumber) {
    delete tables[tableNumber];
    showNotification(`โต๊ะ ${tableNumber} ว่างแล้ว`);
    updateTables();
  }

  function updateTables() {
    const container = document.getElementById("tables");
    container.innerHTML = "";
    Object.keys(tables).forEach(tableNumber => {
      const t = tables[tableNumber];
      const div = document.createElement("div");
      div.classList.add("table");
      div.innerHTML = `
        <p>โต๊ะ ${tableNumber}</p>
        <p>เหลือเวลา: ${formatTime(t.remainingTime)}</p>
        <button class="remove-btn" onclick="removeTable(${tableNumber})">ออก</button>
      `;
      container.appendChild(div);
    });
    document.getElementById("availableTables").textContent = `จำนวนโต๊ะที่กำลังใช้งาน: ${Object.keys(tables).length}`;
  }
</script>
