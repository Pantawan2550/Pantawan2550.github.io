<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบจัดการคิว (Real-time)</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    /* สไตล์เหมือนเดิม */
  </style>
</head>
<body>
  <div class="container">
    <div id="clock"></div>
    <h2>ระบบจัดการคิว</h2>

    <div class="queue-group">
      <div class="input-item">
        <label for="lambda">λ (ลูกค้ามาถึง/นาที):</label>
        <input type="number" id="lambda" step="any" placeholder="เช่น 2" />
      </div>
      <div class="input-item">
        <label for="mu">μ (บริการ/นาที):</label>
        <input type="number" id="mu" step="any" placeholder="เช่น 3" />
      </div>
      <div class="input-item">
        <label for="servers">จำนวนพนักงาน (s):</label>
        <input type="number" id="servers" placeholder="เช่น 2" />
      </div>
    </div>

    <div class="input-group">
      <div class="input-item">
        <label for="queueNumber">หมายเลขคิว:</label>
        <input type="number" id="queueNumber" min="1" />
      </div>
      <button onclick="addQueue()">เพิ่มคิว</button>
    </div>

    <div class="notification" id="notification"></div>
    <div class="queue-container" id="queues"></div>
    <div class="current-queue-count" id="queueCount"></div>
  </div>

  <script>
    // ✅ 1. ตั้งค่า Firebase (ใส่ config ของคุณเองตรงนี้)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const queueRef = db.ref("queues");

    const usedQueueNumbers = new Set();

    setInterval(() => {
      document.getElementById("clock").textContent =
        `เวลา: ${new Date().toLocaleTimeString("th-TH", { hour12: false })}`;
    }, 1000);

    function showNotification(message) {
      const note = document.getElementById("notification");
      note.textContent = message;
      note.style.display = "block";
      setTimeout(() => (note.style.display = "none"), 4000);
    }

    function calculateMMS(lambda, mu, s) {
      const ρ = lambda / (s * mu);
      if (ρ >= 1) return null;
      let sum = 0;
      for (let k = 0; k < s; k++) {
        sum += Math.pow(lambda / mu, k) / factorial(k);
      }
      const lastTerm = Math.pow(lambda / mu, s) / (factorial(s) * (1 - ρ));
      const P0 = 1 / (sum + lastTerm);
      const Lq = (P0 * Math.pow(lambda / mu, s) * ρ) / (factorial(s) * Math.pow(1 - ρ, 2));
      const Wq = Lq / lambda;
      return Wq * 60;
    }

    function factorial(n) {
      return n <= 1 ? 1 : n * factorial(n - 1);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m} นาที ${s} วินาที`;
    }

    function addQueue() {
      const queueNumber = parseInt(document.getElementById("queueNumber").value);
      const lambda = parseFloat(document.getElementById("lambda").value);
      const mu = parseFloat(document.getElementById("mu").value);
      const s = parseInt(document.getElementById("servers").value);

      if (isNaN(queueNumber) || queueNumber < 1) return showNotification("กรุณาใส่หมายเลขคิวให้ถูกต้อง");
      if (isNaN(lambda) || isNaN(mu) || isNaN(s) || lambda <= 0 || mu <= 0 || s < 1)
        return showNotification("กรุณาใส่ λ, μ และจำนวนพนักงานให้ถูกต้อง");

      queueRef.once("value").then(snapshot => {
        const currentQueues = snapshot.val() || {};
        if (currentQueues[queueNumber]) {
          showNotification(`คิว ${queueNumber} มีอยู่แล้ว`);
          return;
        }

        const waitTime = calculateMMS(lambda, mu, s);
        if (waitTime === null) {
          showNotification("ระบบเกินความสามารถในการบริการ (λ ≥ sμ)");
          return;
        }

        let adjustedTime = Math.ceil(waitTime);
        const currentQueueTimes = Object.values(currentQueues).map(q => q.remainingTime);
        const index = currentQueueTimes.length;
        if (index >= s) {
          if (index % s === 0) {
            const sum = currentQueueTimes.slice(index - s, index).reduce((a, b) => a + b, 0);
            adjustedTime += sum;
          } else {
            adjustedTime += currentQueueTimes[index - 1];
          }
        }

        queueRef.child(queueNumber).set({
          remainingTime: adjustedTime,
          timestamp: Date.now()
        });
      });
    }

    function updateQueuesUI(queues) {
      const container = document.getElementById("queues");
      container.innerHTML = "";
      Object.keys(queues).forEach(queueNumber => {
        const t = queues[queueNumber];
        const div = document.createElement("div");
        div.classList.add("queue-box");
        div.innerHTML = `
          <p>คิว ${queueNumber}</p>
          <p>เหลือเวลา: ${formatTime(t.remainingTime)}</p>
          <button class="remove-btn" onclick="removeQueue(${queueNumber})">เสร็จ</button>
        `;
        container.appendChild(div);
      });
      document.getElementById("queueCount").textContent =
        `จำนวนคิวที่กำลังให้บริการ: ${Object.keys(queues).length}`;
    }

    function removeQueue(queueNumber) {
      queueRef.child(queueNumber).remove();
    }

    // ✅ ตัวจับเวลาเรียลไทม์
    setInterval(() => {
      queueRef.once("value", snapshot => {
        const queues = snapshot.val() || {};
        Object.keys(queues).forEach(queueNumber => {
          const q = queues[queueNumber];
          if (q.remainingTime > 0) {
            queueRef.child(queueNumber).update({
              remainingTime: q.remainingTime - 1
            });
          } else {
            queueRef.child(queueNumber).remove();
          }
        });
      });
    }, 1000);

    // ✅ Sync UI แบบ real-time ข้ามเครื่อง
    queueRef.on("value", snapshot => {
      const queues = snapshot.val() || {};
      updateQueuesUI(queues);
    });
  </script>
</body>
</html>
